# 001 - OpenClaw 模型配置指南

## 配置文件

- **路径**: `~/.openclaw/openclaw.json`
- **格式**: JSON5（支持注释和尾逗号）
- **验证**: Zod schema，校验失败时 Gateway 不会启动，可用 `openclaw doctor` 排查

## 核心配置结构

```json5
{
  "models": {
    "mode": "merge",           // "merge" 与内置 provider 合并（默认），"replace" 完全替换
    "providers": {
      "<provider-name>": {
        "baseUrl": "...",      // 必填，API 端点
        "apiKey": "...",       // 可选，支持 ${ENV_VAR} 语法
        "api": "...",          // API 协议类型
        "auth": "...",         // 认证模式
        "headers": {},         // 自定义请求头
        "models": [...]        // 必填，至少一个模型定义
      }
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "<provider>/<model-id>",      // 默认主模型
        "fallbacks": ["<provider>/<model-id>"]    // 备选模型列表
      }
    }
  }
}
```

## API 协议类型 (`api` 字段)

| 值 | 适用场景 |
|---|---|
| `openai-completions` | OpenAI 兼容接口（Deepseek、Moonshot、vLLM、LM Studio 等） |
| `openai-responses` | OpenAI 结构化响应 |
| `anthropic-messages` | Anthropic Claude |
| `google-generative-ai` | Google Gemini |
| `github-copilot` | GitHub Copilot |
| `bedrock-converse-stream` | AWS Bedrock |

## 认证模式 (`auth` 字段)

可选值: `api-key`、`aws-sdk`、`oauth`、`token`

## 模型定义字段

```json5
{
  "id": "deepseek-chat",        // 必填，模型标识符，引用格式: "provider/id"
  "name": "Deepseek Chat",      // 必填，显示名称
  "api": "openai-completions",  // 可选，覆盖 provider 级别设置
  "reasoning": false,           // 是否支持推理模式
  "input": ["text"],            // 输入类型: "text"、"image"
  "cost": {
    "input": 0.14,              // 每百万 token 输入成本（美元）
    "output": 0.28,
    "cacheRead": 0.014,
    "cacheWrite": 0.14
  },
  "contextWindow": 65536,       // 上下文窗口大小（tokens）
  "maxTokens": 8192,            // 最大输出长度
  "headers": {},                // 模型级自定义请求头
  "compat": {}                  // 兼容性标志
}
```

## 环境变量替换

配置文件中的字符串值支持 `${VAR_NAME}` 语法：

```json5
{
  "apiKey": "${DEEPSEEK_API_KEY}"   // 从环境变量读取
}
```

规则：
- 仅匹配大写变量名: `[A-Z_][A-Z0-9_]*`
- 变量未定义或为空时，配置加载报错
- 用 `$${VAR}` 转义输出字面量 `${VAR}`

也可以在配置文件的 `env` 段定义默认值（仅在环境变量未设置时生效）：

```json5
{
  "env": {
    "DEEPSEEK_API_KEY": "sk-xxx"
  }
}
```

## 实际配置示例

### Deepseek

```json5
{
  "models": {
    "mode": "merge",
    "providers": {
      "deepseek": {
        "baseUrl": "https://api.deepseek.com/v1",
        "apiKey": "${DEEPSEEK_API_KEY}",
        "api": "openai-completions",
        "models": [
          {
            "id": "deepseek-chat",
            "name": "Deepseek Chat",
            "reasoning": false,
            "input": ["text"],
            "cost": { "input": 0.14, "output": 0.28, "cacheRead": 0.014, "cacheWrite": 0.14 },
            "contextWindow": 65536,
            "maxTokens": 8192
          },
          {
            "id": "deepseek-reasoner",
            "name": "Deepseek Reasoner (R1)",
            "reasoning": true,
            "input": ["text"],
            "cost": { "input": 0.55, "output": 2.19, "cacheRead": 0.14, "cacheWrite": 0.55 },
            "contextWindow": 65536,
            "maxTokens": 8192
          }
        ]
      }
    }
  },
  "agents": {
    "defaults": {
      "model": { "primary": "deepseek/deepseek-chat" }
    }
  }
}
```

### Moonshot (Kimi)

```json5
{
  "models": {
    "providers": {
      "moonshot": {
        "baseUrl": "https://api.moonshot.ai/v1",
        "apiKey": "${MOONSHOT_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "kimi-k2.5", "name": "Kimi K2.5", "reasoning": false, "input": ["text"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 131072, "maxTokens": 8192 }
        ]
      }
    }
  }
}
```

### 本地模型 (LM Studio / vLLM / Ollama)

```json5
{
  "models": {
    "providers": {
      "local": {
        "baseUrl": "http://localhost:1234/v1",
        "apiKey": "not-needed",
        "api": "openai-completions",
        "models": [
          { "id": "qwen2.5-72b", "name": "Qwen 2.5 72B", "reasoning": false, "input": ["text"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 131072, "maxTokens": 8192 }
        ]
      }
    }
  }
}
```

Ollama 默认自动发现 `http://127.0.0.1:11434/v1`，无需额外配置。

### 多 Provider + 模型回退

```json5
{
  "models": {
    "mode": "merge",
    "providers": {
      "deepseek": {
        "baseUrl": "https://api.deepseek.com/v1",
        "apiKey": "${DEEPSEEK_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "deepseek-chat", "name": "Deepseek Chat", "reasoning": false, "input": ["text"],
            "cost": { "input": 0.14, "output": 0.28, "cacheRead": 0.014, "cacheWrite": 0.14 },
            "contextWindow": 65536, "maxTokens": 8192 }
        ]
      },
      "moonshot": {
        "baseUrl": "https://api.moonshot.ai/v1",
        "apiKey": "${MOONSHOT_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "kimi-k2.5", "name": "Kimi K2.5", "reasoning": false, "input": ["text"],
            "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
            "contextWindow": 131072, "maxTokens": 8192 }
        ]
      }
    }
  },
  "agents": {
    "defaults": {
      "model": {
        "primary": "deepseek/deepseek-chat",
        "fallbacks": ["moonshot/kimi-k2.5"]
      }
    }
  }
}
```

## CLI 常用命令

```bash
openclaw models list              # 列出所有可用模型
openclaw models set <provider/id> # 设置默认模型
openclaw models status            # 查看模型状态和认证信息
openclaw models aliases list      # 列出模型别名
openclaw models aliases add <alias> <provider/id>  # 添加别名
openclaw doctor                   # 诊断配置问题
```

## 关键源码位置

| 文件 | 用途 |
|---|---|
| `src/config/types.models.ts` | 模型配置 TypeScript 类型定义 |
| `src/config/zod-schema.core.ts` | Zod 校验 schema |
| `src/agents/models-config.providers.ts` | Provider 实现细节 |
| `docs/concepts/model-providers.md` | 官方文档：模型 Provider |
| `docs/concepts/models.md` | 官方文档：模型配置 |
| `docs/gateway/configuration.md` | 官方文档：完整配置参考 |
| `docs/gateway/configuration-examples.md` | 官方文档：配置示例 |

## 连接测试

快速验证 API 连通性（以 Deepseek 为例）：

```bash
curl -s https://api.deepseek.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
  -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"ping"}],"max_tokens":5}'
```

返回 HTTP 200 且包含 `choices` 即为正常。
